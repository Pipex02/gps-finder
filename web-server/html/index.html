<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Geo Finder</title>
    <link rel="stylesheet" href="styles1.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <header class="title-container">
        <img src="LogoGeoFinder500.webp" alt="Logo" class="title-image">
        <h1 class="title">Geo Finder</h1>
    </header>
    <div class="popup" id="welcome-popup">
        <div class="popup-content">
            <span class="popup-close" id="welcome-close">&times;</span>
            <h2>¬°Bienvenido a Geo Finder!</h2>
            <p>Esta p√°gina te permite visualizar tu ubicaci√≥n actual en un mapa, ver una variable cambiante en tiempo real, y consultar hist√≥ricos de rutas pasadas. üöÄ</p>
        </div>
    </div>
    <div class="content">
        <div id="map-container">
            <div id="map"></div>
            <div class="location-info-container">
                <div class="card location-card-individual">
                    <div class="head">Latitud</div>
                    <div class="card-content">
                        <p><span id="latitud">Obteniendo...</span></p>
                    </div>
                </div>
                <div class="card location-card-individual">
                    <div class="head">Longitud</div>
                    <div class="card-content">
                        <p><span id="longitud">Obteniendo...</span></p>
                    </div>
                </div>
                <div class="card location-card-individual">
                    <div class="head">Tiempo</div>
                    <div class="card-content">
                        <p><span id="timestamp">Obteniendo...</span></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="info">
            <!-- Tarjeta para selecci√≥n de veh√≠culo -->
            <div class="card vehicle-selection-card">
                <div class="head">Seleccionar Veh√≠culo</div>
                <div class="card-content">
                    <select id="vehicleSelect">
                        <option value="1">Veh√≠culo 1</option>
                        <option value="2">Veh√≠culo 2</option>
                    </select>
                </div>
            </div>
            <!-- Tarjeta de Gasolina -->
            <div class="card variable-card">
                <div class="head">
                    Gasolina
                    <span class="info-icon fa-solid fa-circle-info" data-popup="variable-popup"></span>
                </div>
                <div class="card-content">
                    <p><span id="gasolina">Obteniendo...</span></p>
                </div>
            </div>
            <!-- Tarjeta de Velocidad -->
            <div class="card variable-card">
                <div class="head">
                    Velocidad
                    <span class="info-icon fa-solid fa-circle-info" data-popup="velocity-popup"></span>
                </div>
                <div class="card-content">
                    <p><span id="velocidad">Obteniendo...</span></p>
                </div>
            </div>
            <!-- Tarjeta de Hist√≥ricos -->
            <div class="card history-card">
                <img src="alien.webp" alt="Alien" class="alien">
                <div class="head">
                    Hist√≥ricos
                    <span class="info-icon fa-solid fa-circle-info" data-popup="history-popup"></span>
                </div>
                <div class="card-content">
                    <p>Ac√° podr√°s consultar rutas en los d√≠as deseados</p>
                    <a href="historicos.html" class="button">Consultar</a>
                </div>
            </div>
            <!-- Popups informativos -->
            <div class="popup" id="location-popup">
                <div class="popup-content">
                    <span class="popup-close">√ó</span>
                    <h2>Datos de Ubicaci√≥n</h2>
                    <p>Esta secci√≥n muestra la latitud, longitud y estampa de tiempo de tu ubicaci√≥n actual, obtenida mediante geolocalizaci√≥n.</p>
                </div>
            </div>
            <div class="popup" id="variable-popup">
                <div class="popup-content">
                    <span class="popup-close">√ó</span>
                    <h2>Gasolina</h2>
                    <p>‚õΩüöó Consulta el nivel de gasolina del veh√≠culo en tiempo real.</p>
                </div>
            </div>
            <div class="popup" id="velocity-popup">
                <div class="popup-content">
                    <span class="popup-close">√ó</span>
                    <h2>velocidad</h2>
                    <p>üöóüí® Consulta la velocidad del veh√≠culo en tiempo real.</p>
                </div>
            </div>
            <div class="popup" id="history-popup">
                <div class="popup-content">
                    <span class="popup-close">√ó</span>
                    <h2>Hist√≥ricos</h2>
                    <p>Consulta rutas pasadas ingresando fechas espec√≠ficas.</p>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="progress-bar.js"></script>
    <script src="speedometer.js"></script>
    <script>
        async function getConfig() {
            const response = await fetch('/api/config'); 
            if (!response.ok) throw new Error("Error al obtener la configuraci√≥n");
            const config = await response.json();
            return config;
        }
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const config = await getConfig();
                if (config.pageTitle) {
                    document.getElementById('page-title').textContent = config.pageTitle || "Geo Finder";
                }
            } catch (error) {
                console.error("Error al cargar la configuraci√≥n:", error);
            }
        });
    </script>
    <script>
        var map = L.map('map').setView([10.99385, -74.79261], 12); // Mapa inicial

        // Capa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        
        var marker;  // Variable para el marcador
        var route = [];  // Almacena la ruta recorrida
        var polyline = L.polyline([], {color: '#004e92', weight: 6}).addTo(map); // L√≠nea de la ruta

        async function obtenerCoordenadasDesdeAPI() {
            const vehicleSelect = document.getElementById('vehicleSelect');
            const vehicleID = vehicleSelect ? vehicleSelect.value : '';
            const url = vehicleID ? `/api/coordenadas?VehicleID=${vehicleID}` : `/api/coordenadas`;

            try {
                const respuesta = await fetch(url);
                if (!respuesta.ok) {
                    throw new Error('Error al obtener datos de la API');
                }
                const datos = await respuesta.json();

                if (!datos || Object.keys(datos).length === 0) {
                    document.getElementById("latitud").innerText = "0";
                    document.getElementById("longitud").innerText = "0";
                    document.getElementById("timestamp").innerText = "0";
                    //document.getElementById("gasolina").innerText = "0";
                   // document.getElementById("velocidad").innerText = "0";
                    return;
                }
                if (datos.latitud && datos.longitud && datos.timestamp) {
                    document.getElementById("latitud").innerText = datos.latitud;
                    document.getElementById("longitud").innerText = datos.longitud;
                    function formatearTimestamp(timestamp) {
                        return timestamp.replace("T", " ").split(".")[0];
                    }
                    document.getElementById("timestamp").innerText = formatearTimestamp(datos.timestamp);
                    //document.getElementById("gasolina").innerText = datos.gasolina;
                    //document.getElementById("velocidad").innerText = datos.velocidad;
                    
                    var lat = parseFloat(datos.latitud);
                    var lon = parseFloat(datos.longitud);
                    
                    route.push([lat, lon]);

                    if (marker) {
                        marker.setLatLng([lat, lon]);
                        marker.openPopup();
                    } else {
                        marker = L.marker([lat, lon]).addTo(map)
                            .bindPopup("√öltima ubicaci√≥n registrada").openPopup();
                    }

                    // Redibujar la l√≠nea de la ruta
                    polyline.setLatLngs(route);

                    // Centrar el mapa en la nueva ubicaci√≥n
                    map.setView([lat, lon]);
                } else {
                    document.getElementById("latitud").innerText = "0";
                    document.getElementById("longitud").innerText = "0";
                    document.getElementById("timestamp").innerText = "0";
                    //document.getElementById("gasolina").innerText = "0";
                    //document.getElementById("velocidad").innerText = "0";
                }
            } catch (error) {
                console.error('‚ùå Error al obtener datos:', error);
            }
        }
        obtenerCoordenadasDesdeAPI();
        setInterval(obtenerCoordenadasDesdeAPI, 5000);
        document.getElementById('vehicleSelect').addEventListener('change', function() {
            // Si deseas reiniciar la trayectoria, descomenta la siguiente l√≠nea:
            // route = [];
            obtenerCoordenadasDesdeAPI();
        });
    </script>
    <script>
        for (let i = 0; i < 100; i++) {
            let star = document.createElement('div');
            star.className = 'star';
            star.style.top = Math.random() * 100 + '%';
            star.style.left = Math.random() * 100 + '%';
            document.body.appendChild(star);
        }
        for (let i = 0; i < 30; i++) {
            let meteor = document.createElement('div');
            meteor.className = 'meteor';
            meteor.style.top = Math.random() * 100 + '%';
            meteor.style.left = Math.random() * 100 + '%';
            meteor.style.animationDelay = Math.random() * 5 + 's';
            document.body.appendChild(meteor);
        }
    </script>
    <script>
        document.querySelectorAll('.info-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                const popupId = icon.getAttribute('data-popup');
                document.getElementById(popupId).style.display = 'block';
            });
        });
        document.querySelectorAll('.popup-close').forEach(close => {
            close.addEventListener('click', () => {
                close.closest('.popup').style.display = 'none';
            });
        });
        window.addEventListener('click', (e) => {
            document.querySelectorAll('.popup').forEach(popup => {
                if (e.target === popup) {
                    popup.style.display = 'none';
                }
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const welcomePopup = document.getElementById("welcome-popup");
            const closeBtn = document.getElementById("welcome-close");
            if (!localStorage.getItem('welcomeShown')) {
                welcomePopup.style.display = "flex";
                localStorage.setItem('welcomeShown', 'true');
            }
            closeBtn.addEventListener("click", () => {
                welcomePopup.style.display = "none";
            });
        });
    </script>
</body>
</html>