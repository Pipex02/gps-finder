<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Consulta de Históricos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: "Arial", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-image: url("perrito.webp"); /* Asegúrate de que la ruta a la imagen es correcta */
            background-size: cover;
            background-position: center;
        }

        header.title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        header.title-container img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
        }

        header.title-container h1 {
            margin: 0;
            font-size: 1.8em;
            color: #004e92;
        }

        .content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            flex: 1;
        }

        #map-container {
            width: 90%;
            height: 400px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        .info {
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .card h2 {
            margin-top: 0;
            color: #004e92;
        }

        .card input[type="datetime-local"],
        .card select,
        .card input[type="text"],
        .card input[type="number"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .card .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }

        .card .button {
            padding: 10px 20px;
            background-color: #004e92;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .card .button:hover {
            background-color: #003366;
        }

        .suggestions {
            position: absolute;
            z-index: 1000;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(90% - 20px);
            margin-top: 5px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .suggestions .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestions .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        #back-button {
            padding: 10px 20px;
            background-color: #004e92;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }

        #back-button:hover {
            background-color: #003366;
        }

        .star {
            position: absolute;
            background-color: white;
            width: 2px;
            height: 2px;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }

        .meteor {
            position: absolute;
            background: linear-gradient(to right, rgba(255, 255, 255, 0), white);
            width: 100px;
            height: 3px;
            transform: rotate(-45deg);
            animation: shootingStar 3s infinite;
        }

        @keyframes twinkle {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        @keyframes shootingStar {
            0% {
                left: 0;
                top: 0;
                opacity: 0;
            }
            20% {
                opacity: 0.7;
            }
            80% {
                left: 100%;
                top: 100%;
                opacity: 0;
            }
            100% {
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 10px;
            }

            #map-container {
                width: 100%;
                height: 300px;
            }

            .info {
                width: 100%;
            }

            .card input[type="datetime-local"],
            .card select,
            .card input[type="text"],
            .card input[type="number"] {
                width: calc(100% - 10px);
                padding: 8px;
            }

            .card .button {
                padding: 10px;
                width: 100%;
            }

            header.title-container h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <header class="title-container">
        <a href="index.html" id="back-button" class="button">Regresar</a>
        <img src="perrito.webp" alt="perrito" class="title-image" />
        <h1 class="title">Históricos</h1>
    </header>
    <div class="content">
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div class="info">
            <section class="card datetime-card">
                <h2>Fecha y hora de inicio:</h2>
                <input type="datetime-local" id="startDateTime" />
                <br /><br />
                <h2>Fecha y hora de fin:</h2>
                <input type="datetime-local" id="endDateTime" />
                <br /><br />
                <div class="button-container">
                    <button class="button" onclick="consultar()">Consultar</button>
                    <h2>Ciudad:</h2>
                    <select id="city-select">
                        <option value="Barranquilla" selected>Barranquilla</option>
                        <option value="Bogotá">Bogotá</option>
                        <option value="Medellín">Medellín</option>
                        <option value="Cali">Cali</option>
                        <option value="Cartagena">Cartagena</option>
                    </select>
                    <br /><br />
                    <input type="text" id="location-input" placeholder="Ingrese ubicación" />
                    <div id="suggestions-box" class="suggestions"></div>
                    <input type="number" id="radius-input" placeholder="Radio (m)" min="10" max="5000" />
                    <button id="consult-button" class="button" disabled>Consultar Ubicación Específica</button>
                </div>
            </section>
        </div>
    </div>
    <script>
        // Generar estrellas y meteoros
        function generarElementosDecorativos() {
            for (let i = 0; i < 100; i++) {
                const star = document.createElement("div");
                star.className = "star";
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                document.body.appendChild(star);
            }
            for (let i = 0; i < 30; i++) {
                const meteor = document.createElement("div");
                meteor.className = "meteor";
                meteor.style.top = `${Math.random() * 100}%`;
                meteor.style.left = `${Math.random() * 100}%`;
                meteor.style.animationDelay = `${Math.random() * 5}s`;
                document.body.appendChild(meteor);
            }
        }

        // Inicializar el mapa
        const map = L.map("map").setView([10.99385, -74.79261], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap contributors",
        }).addTo(map);

        let startMarker, endMarker, locationCircle;
        const polyline = L.polyline([], { color: "#004e92", weight: 6 }).addTo(map);
        const filteredPolyline = L.polyline([], { color: "#32CD32", weight: 6 }).addTo(map); // Add to map

        // Configuración inicial de fechas
        const startDateTime = document.getElementById("startDateTime");
        const endDateTime = document.getElementById("endDateTime");
        const consultButton = document.getElementById("consult-button");

        const minDate = new Date("2025-03-25T00:00:00");
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const endOfDay = new Date();
        endOfDay.setHours(23, 59, 0, 0);

        const toLocalISOString = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().slice(0, 16);
        };

        startDateTime.min = toLocalISOString(minDate);
        startDateTime.max = toLocalISOString(today);
        startDateTime.value = toLocalISOString(today);
        endDateTime.min = startDateTime.value;
        endDateTime.max = toLocalISOString(endOfDay);
        endDateTime.value = toLocalISOString(endOfDay);

        startDateTime.addEventListener("change", () => {
            const startValue = new Date(startDateTime.value);
            endDateTime.min = toLocalISOString(startValue);
            if (new Date(endDateTime.value) <= startValue) {
                let adjustedEnd = new Date(startValue);
                adjustedEnd.setMinutes(adjustedEnd.getMinutes() + 1);
                endDateTime.value = toLocalISOString(adjustedEnd);
            }
        });

        endDateTime.addEventListener("change", () => {
            const startValue = new Date(startDateTime.value);
            const endValue = new Date(endDateTime.value);
            if (endValue <= startValue) {
                let adjustedEnd = new Date(startValue);
                adjustedEnd.setMinutes(adjustedEnd.getMinutes() + 1);
                endDateTime.value = toLocalISOString(adjustedEnd);
            }
        });

        // Funciones de control del botón
        const inhabilitarBoton = () => {
            consultButton.disabled = true;
        };
        const habilitarBoton = () => {
            consultButton.disabled = false;
        };

        // Actualizar restricciones de fechas
        function actualizarRestricciones() {
            const startValue = startDateTime.value;
            if (startValue) {
                endDateTime.min = startValue;
                if (endDateTime.value && endDateTime.value < startValue) {
                    endDateTime.value = startValue;
                }
            }
            inhabilitarBoton();
        }

        // Consultar la API de históricos
        function consultar() {
            const startInput = startDateTime.value;
            const endInput = endDateTime.value;

            if (!startInput || !endInput) {
                alert("Selecciona ambas fechas y horas.");
                return;
            }

            const startDate = new Date(startInput);
            const endDate = new Date(endInput);
            if (endDate <= startDate) {
                alert("La fecha y hora de fin deben ser posteriores a la de inicio.");
                return;
            }

            const startFormatted = `${startInput.replace("T", " ")}:00`;
            const endFormatted = `${endInput.replace("T", " ")}:00`;

            fetch(`/api/historicos?inicio=${encodeURIComponent(startFormatted)}&fin=${encodeURIComponent(endFormatted)}`)
                .then((response) => {
                    if (!response.ok) throw new Error("Error en la respuesta de la API");
                    return response.json();
                })
                .then((data) => {
                    if (!data || data.length === 0) {
                        alert("No hay datos en este rango de tiempo.");
                        inhabilitarBoton();
                        polyline.setLatLngs([]); // Clear previous polyline
                        if (startMarker) map.removeLayer(startMarker);
                        if (endMarker) map.removeLayer(endMarker);
                        return;
                    }

                    const route = data.map((coord) => {
                        const lat = parseFloat(coord.latitud);
                        const lon = parseFloat(coord.longitud);
                        if (isNaN(lat) || isNaN(lon)) {
                            console.warn("Invalid coordinates:", coord);
                            return null; // Filter out invalid points
                        }
                        return [lat, lon];
                    }).filter(coord => coord !== null); // Remove nulls

                    polyline.setLatLngs(route);
                    if (!map.hasLayer(polyline)) polyline.addTo(map);

                    if (startMarker) map.removeLayer(startMarker);
                    if (endMarker) map.removeLayer(endMarker);

                    if (route.length > 0) {
                        startMarker = L.marker(route[0], {
                            icon: L.divIcon({
                                className: "custom-marker",
                                html: '<div style="color: black; font-weight: bold; background: #FFD700; padding: 8px; border-radius: 50%; text-align: center;">A</div>',
                                iconSize: [35, 35],
                            }),
                        })
                            .bindPopup(`Inicio: ${data[0].timestamp}`)
                            .addTo(map);

                        endMarker = L.marker(route[route.length - 1], {
                            icon: L.divIcon({
                                className: "custom-marker",
                                html: '<div style="color: white; font-weight: bold; background: #4B0082; padding: 8px; border-radius: 50%; text-align: center;">B</div>',
                                iconSize: [35, 35],
                            }),
                        })
                            .bindPopup(`Fin: ${data[data.length - 1].timestamp}`)
                            .addTo(map);
                    }

                    map.fitBounds(polyline.getBounds());
                    habilitarBoton();
                })
                .catch((error) => {
                    console.error("Error al obtener datos históricos:", error);
                    inhabilitarBoton();
                    alert("Error al consultar la API. Intenta de nuevo.");
                });
        }

        // Funciones de Geoapify
        async function getConfig() {
            const response = await fetch("/api/config");
            if (!response.ok) throw new Error("Error al obtener la configuración");
            const config = await response.json();
            return config;
        }

        async function fetchAutocomplete(query, city, apiKey) {
            const response = await fetch(
                `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&city=${encodeURIComponent(city)}&limit=4&apiKey=${apiKey}`
            );
            if (!response.ok) {
                throw new Error(`Geocoding API error: ${response.status}`);
            }
            const data = await response.json();
            return data.features.map((feature) => ({
                label: feature.properties.formatted,
                lat: feature.properties.lat,
                lon: feature.properties.lon,
            }));
        }

        async function fetchCoordinates(address, city, apiKey) {
            const response = await fetch(
                `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(address)}&city=${encodeURIComponent(city)}&limit=1&apiKey=${apiKey}`
            );
            if (!response.ok) {
                throw new Error(`Geocoding API error: ${response.status}`);
            }
            const data = await response.json();

            if (data.features.length > 0) {
                return {
                    lat: data.features[0].properties.lat,
                    lon: data.features[0].properties.lon,
                };
            }
            return null;
        }

        // Nueva función para consultar ubicaciones dentro del radio
        async function consultarUbicacionEspecifica() {
            const address = document.getElementById("location-input").value;
            const city = document.getElementById("city-select").value;
            const radius = document.getElementById("radius-input").value;
            const config = await getConfig();
            const apiKey = config.geoapifyApiKey;

            if (!address || !radius) {
                alert("Por favor, ingrese una ubicación y un radio.");
                return;
            }

            const coords = await fetchCoordinates(address, city, apiKey);
            if (!coords) {
                alert("Ubicación no encontrada.");
                return;
            }

            const { lat, lon } = coords;
            const startInput = startDateTime.value;
            const endInput = endDateTime.value;

            if (!startInput || !endInput) {
                alert("Selecciona ambas fechas y horas.");
                return;
            }

            const startFormatted = `${startInput.replace("T", " ")}:00`;
            const endFormatted = `${endInput.replace("T", " ")}:00`;

            fetch(`/api/lugar?latitud=${lat}&longitud=${lon}&radio=${radius}&inicio=${encodeURIComponent(startFormatted)}&fin=${encodeURIComponent(endFormatted)}`)
                .then((response) => {
                    if (!response.ok) throw new Error("Error en la respuesta de la API");
                    return response.json();
                })
                .then((data) => {
                    if (!data || data.length === 0) {
                        alert("No hay datos en este rango de tiempo dentro del radio seleccionado.");
                        filteredPolyline.setLatLngs([]); // Clear polyline
                        if (startMarker) map.removeLayer(startMarker);
                        if (endMarker) map.removeLayer(endMarker);
                        if (locationCircle) map.removeLayer(locationCircle);
                        return;
                    }
                    const route = data.map((coord) => {
                        const lat = parseFloat(coord.latitud);
                        const lon = parseFloat(coord.longitud);
                        if (isNaN(lat) || isNaN(lon)) {
                            console.warn("Invalid coordinates:", coord);
                            return null; // Filter out invalid points
                        }
                        return [lat, lon];
                    }).filter(coord => coord !== null);

                    filteredPolyline.setLatLngs(route);

                    if (!map.hasLayer(filteredPolyline)) {
                        filteredPolyline.addTo(map);
                    }

                    if (startMarker) map.removeLayer(startMarker);
                    if (endMarker) map.removeLayer(endMarker);
                    if (locationCircle) map.removeLayer(locationCircle);

                    if (route.length > 0) {
                        startMarker = L.marker(route[0], {
                            icon: L.divIcon({
                                className: "custom-marker",
                                html: '<div style="color: black; font-weight: bold; background: #FFD700; padding: 8px; border-radius: 50%; text-align: center;">A</div>',
                                iconSize: [35, 35],
                            }),
                        })
                            .bindPopup(`Inicio: ${data[0].timestamp}`)
                            .addTo(map);

                        endMarker = L.marker(route[route.length - 1], {
                            icon: L.divIcon({
                                className: "custom-marker",
                                html: '<div style="color: white; font-weight: bold; background: #4B0082; padding: 8px; border-radius: 50%; text-align: center;">B</div>',
                                iconSize: [35, 35],
                            }),
                        })
                            .bindPopup(`Fin: ${data[data.length - 1].timestamp}`)
                            .addTo(map);
                    }

                    // Dibujar círculo solo con contorno
                    locationCircle = L.circle([lat, lon], {
                        color: "#32CD32", // Verde igual que la polilínea
                        weight: 2, // Grosor del contorno
                        fill: false, // Sin relleno
                        radius: parseFloat(radius),
                    }).addTo(map);

                    map.fitBounds(filteredPolyline.getBounds());
                })
                .catch((error) => {
                    console.error("Error al obtener datos de ubicación:", error);
                    alert("Error al consultar la API. Intenta de nuevo.");
                });
        }

        // Inicialización
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const config = await getConfig();
                const apiKey = config.geoapifyApiKey;

                // Actualizar el título de la página con el valor de APP_TITLE
                if (config.pageTitle) {
                    document.getElementById("page-title").textContent = config.pageTitle || "Consulta de Históricos";
                }

                const locationInput = document.getElementById("location-input");
                const suggestionsBox = document.getElementById("suggestions-box");
                const citySelect = document.getElementById("city-select");
                const radiusInput = document.getElementById("radius-input");
                const consultButtonElem = document.getElementById("consult-button"); // Correct ID

                // Autocompletado
                locationInput.addEventListener("input", async () => {
                    const query = locationInput.value;
                    const city = citySelect.value;
                    if (query.length < 7) {
                        suggestionsBox.style.display = "none";
                        return;
                    }

                    try {
                        const suggestions = await fetchAutocomplete(query, city, apiKey);
                        suggestionsBox.innerHTML = "";
                        suggestions.forEach((suggestion, index) => {
                            const div = document.createElement("div");
                            div.className = "suggestion-item";
                            div.textContent = suggestion.label;
                            div.dataset.index = index;
                            div.addEventListener("click", () => {
                                locationInput.value = suggestion.label;
                                suggestionsBox.style.display = "none";
                                habilitarBoton(); // Enable the button after selecting a suggestion
                            });
                            suggestionsBox.appendChild(div);
                        });
                        suggestionsBox.style.display = suggestions.length > 0 ? "block" : "none";
                    } catch (error) {
                        console.error("Error fetching autocomplete:", error);
                        alert("Error al obtener sugerencias de ubicación. Por favor, intente de nuevo.");
                        suggestionsBox.style.display = "none";
                    }
                });

                locationInput.addEventListener("blur", () => {
                    setTimeout(() => (suggestionsBox.style.display = "none"), 200);
                });

                // Evento para consultar ubicación específica
                consultButtonElem.addEventListener("click", consultarUbicacionEspecifica); // Use the correct variable

                // Enable the button only when both location and radius are provided
                locationInput.addEventListener("input", () => {
                    if (locationInput.value && radiusInput.value) {
                        habilitarBoton();
                    } else {
                        inhabilitarBoton();
                    }
                });

                radiusInput.addEventListener("input", () => {
                    if (locationInput.value && radiusInput.value) {
                        habilitarBoton();
                    } else {
                        inhabilitarBoton();
                    }
                });

                generarElementosDecorativos();
                startDateTime.addEventListener("input", actualizarRestricciones);
                endDateTime.addEventListener("input", actualizarRestricciones);
                inhabilitarBoton();
            } catch (error) {
                console.error("Error al cargar la configuración:", error);
                alert("Error al cargar la página. Por favor, intente de nuevo.");
            }
        });
    </script>
</body>
</html>
