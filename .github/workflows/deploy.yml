name: Deploy to EC2

on:
  push:
    branches:
      - main  # Ejecutar cuando haya un push en main
      
  pull_request:
    branches:
      - main  # Ejecutar cuando haya un pull request a main

jobs:
  deploy:
    runs-on: self-hosted  # Usa el runner autoalojado en EC2

    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ”„ Actualizar cÃ³digo en la EC2
        run: |
          echo "ğŸ“¥ Haciendo pull del cÃ³digo en la EC2..."
          cd /home/ubuntu/gps-finder
          git fetch origin  # Obtiene la Ãºltima informaciÃ³n del repo
          git checkout main  # Asegura que estamos en la rama correcta
          git reset --hard origin/main  # Sincroniza con la versiÃ³n remota
          git pull origin main  # Trae los Ãºltimos cambios del repo
          echo "âœ… CÃ³digo actualizado en la EC2."

      - name: ğŸš€ Ejecutar despliegue en EC2
        run: |
          echo "ğŸ“‚ Moviendo archivos del frontend a /var/www/gps-finder/html/..."
          sudo mkdir -p /var/www/gps-finder/html/
          sudo rsync -av /home/ubuntu/gps-finder/web-server/html/ /var/www/gps-finder/html/
          echo "âœ… Archivos movidos correctamente."

          echo "ğŸ” Asignando permisos a /var/www/gps-finder/html/..."
          sudo chown -R www-data:www-data /var/www/gps-finder/html
          sudo chmod -R 755 /var/www/gps-finder/html
          echo "âœ… Permisos configurados correctamente."

          echo "ğŸ“¦ Instalando dependencias..."
          cd /home/ubuntu/gps-finder/api-rest/
          npm install
            
          cd /home/ubuntu/gps-finder/sniffer-udp/
          source myenv/bin/activate
          pip3 install -r requirements.txt
          deactivate
          echo "âœ… Dependencias instaladas correctamente."

          echo "ğŸ”„ Reiniciando servicios..."
          sudo systemctl restart api-rest
          sudo systemctl restart sniffer-udp
          echo "âœ… Servicios reiniciados correctamente."
